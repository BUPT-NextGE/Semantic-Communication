"""

将最后一个卷积层的输出按照权重排序，选择部分卷积核进行传输，以减少通信资源需求，同时不影响分类性能

"""
from os import name
from PIL import Image
import numpy as np
import torch
from torch.autograd import Variable
# from torchsummary import summary
import random

# from misc_functions import save_class_activation_images
# from model import Classification

'''

可视化自定义分类模型的CAM

'''

def preprocess_image(pil_im, resize_im=True):
    """
        Processes image for CNNs

    Args:
        PIL_img (PIL_img): PIL Image or numpy array to process
        resize_im (bool): Resize to 224 or not
    returns:
        im_as_var (torch variable): Variable that contains processed float tensor
    """
    # mean and std list for channels (Imagenet)
    # mean = [0.485, 0.456, 0.406]
    # std = [0.229, 0.224, 0.225]

    #ensure or transform incoming image to PIL image
    if type(pil_im) != Image.Image:
        try:
            pil_im = Image.fromarray(pil_im)
        except Exception as e:
            print("could not transform PIL_img to a PIL Image object. Please check input.")

    # Resize image
    if resize_im:
        pil_im = pil_im.resize((128, 128), Image.ANTIALIAS)

    im_as_arr = np.float32(pil_im)
    im_as_arr = im_as_arr.transpose(2, 0, 1)  # Convert array to D,W,H
    # Normalize the channels
    for channel, _ in enumerate(im_as_arr):
        im_as_arr[channel] /= 255
        # im_as_arr[channel] -= mean[channel]
        # im_as_arr[channel] /= std[channel]
    # Convert to float tensor
    im_as_ten = torch.from_numpy(im_as_arr).float()
    # Add one more channel to the beginning. Tensor shape = 1,3,224,224
    im_as_ten.unsqueeze_(0)
    # Convert to Pytorch variable
    im_as_var = Variable(im_as_ten, requires_grad=True)
    return im_as_var

class CamExtractor():
    """
        Extracts cam features from the model
    """
    def __init__(self, model, target_layer):
        self.model = model
        self.target_layer = target_layer
        self.gradients = None

    def save_gradient(self, grad):
        self.gradients = grad

    def forward_pass_on_convolutions(self, x):
        """
            Does a forward pass on convolutions, hooks the function at given layer
        """
        conv_output = None
        for name, layer in self.model._modules.items():
            if name == 'e_conv_1' or name == 'e_conv_2':
                x = layer(x)
            elif name == 'e_block_1' or name == 'e_block_2' or name == 'e_block_3':
                x = layer(x) + x
            elif name == self.target_layer:
                x = layer(x)
                # x.register_hook(self.save_gradient)
                conv_output = x  # Save the convolution output on that layer
                return conv_output, x
        # return conv_output, x

    def forward_pass(self, x):
        """
            Does a full forward pass on the model
        """
        # Forward pass on the convolutions
        conv_output, x = self.forward_pass_on_convolutions(x)
        conv_output_np = conv_output.data.numpy()
        x = torch.zeros(conv_output_np.shape)
        # index = [26, 22, 3, 2, 9, 30, 7, 31, 4, 29, 28, 8, 23, 27, 5]
        index = [22, 3, 2, 9, 30, 31, 4, 29, 23, 27, 5]   #删掉对马重要的
        # index = [26, 22, 3, 2, 9, 30, 7, 31, 4, 29, 28, 8, 23, 27, 5, 21, 24, 14, 12, 20, 15, 10, 11, 18, 1, 19, 6, 25, 0, 13, 17, 16]
        x[:, index] = conv_output[:, index]
        x = x.view(x.size(0), -1)  # Flatten
        norm0 = torch.norm(x, dim=1)
        norm0 = norm0.view(norm0.size(0), -1)
        x = torch.div(x, norm0)
        x = self.model.classifier(x)
        return conv_output, x


class CamExtractor_resnet():
    """
        Extracts cam features from the resnet classification model
    """
    def __init__(self, model, index, target_layer):
        self.model = model
        self.target_layer = target_layer
        self.gradients = None
        # N = range(512)
        # m = 10
        # self.index = random.sample(N, m)
        self.index = index

    def save_gradient(self, grad):
        self.gradients = grad

    def forward_pass_on_convolutions(self, x):
        """
            Does a forward pass on convolutions, hooks the function at given layer
        """
        conv_output = None
        for name, layer in self.model._modules.items():
            x = layer(x)  # Forward
            if name == self.target_layer:
                conv_output = x  # Save the convolution output on that layer
                return conv_output, x
        # return conv_output, x

    def forward_pass(self, x):
        """
            Does a full forward pass on the model
        """
        # Forward pass on the convolutions
        conv_output, x = self.forward_pass_on_convolutions(x)
        conv_output_np = conv_output.data.cpu().numpy()
        x = torch.zeros(conv_output_np.shape).to("cuda")
        '''
        # 不加信道的卷积核权重排序
        index = [
            # car
            32, 176, 184, 122, 205, 194, 278, 329, 419, 261, 237, 253, 333, 163, 369, 384, 417,\
            92,  340, 439,  62,  22,  45,  25,   0, 186, 258, 275,  30, 265, 269, 397,48, 408, 402, 141,\
            # 105, 232, 199,  77, 304, 140,  99, 445, 472, 300, 149,   9, 504, 314, 209, 115, 349, 155,\
            # 154, 448,  34, 131,  20, 148,  52, 484, 260,  93, 446, 361, 479, 286,   2, 437,  58,  87,\
            # airplane
            104, 486,   7, 360, 435, 398, 176, 272,  45, 248, 324,  23,  24, 186, 110, 112, 476, 349,\
            214, 487, 109, 503, 403, 102, 407, 377, 422,  72, 343,  93, 416,  82, 101, 417, 367, 321,\
            # 15, 142, 448, 108, 160, 184, 234, 392,  94, 506, 455,  25, 266,  22,  66, 190, 178, 412,\
            # 418, 154,  32, 423, 222, 291, 460, 185, 404, 220,  39, 121, 449,  27, 106,   4, 236, 210,\
            # bird
            17, 102, 247, 394,  82, 459, 264, 313, 301, 511, 245, 393,  59, 487, 434, 255, 347, 402,\
            68, 191, 217, 421, 169,  69, 415, 162, 432, 74, 262, 332, 288, 438, 139, 339, 324, 299,\
            # cat
            156, 298, 310, 301, 179, 198, 314,  51, 158, 309,  97, 167, 331, 303, 499, 348, 285,  61,\
            250, 224, 180, 420, 492, 408, 463, 509, 484, 262, 378,  63, 249, 159,  43, 376, 192,  81,\
            # deer
            202, 316,  17,  78, 318, 333, 361, 489, 456, 280,  86, 214, 443,  42, 126, 181, 411,  61,\
            179, 120,  92, 319, 459, 345, 328, 398, 397, 254, 266, 169, 174, 227, 460, 466, 389, 225,\
            # 492, 124, 140,  38,  41, 211, 439,  40, 320, 215, 468, 276, 199, 325, 338, 213, 241, 385,\
            # 272,   4,  60, 264, 505, 482,  46, 349, 246, 228, 424, 131, 239, 457, 470, 253,  50,  39
            # dog
            83, 418, 331, 282, 473, 271,  56, 285, 400, 138, 150, 497, 390, 134, 244, 348, 169,  36,\
            495, 274, 127, 126,  63, 326, 180, 242,  59,   9, 361,  94,  46, 364, 192,  57, 185, 120,\
            # horse
            42,  69, 148, 414, 217, 475, 371, 455, 219, 375, 133, 316, 454, 432, 240,  60, 446, 151,\
            228, 271, 106, 315,  14, 439, 210, 195, 129, 381, 308, 211, 121, 406, 368,  43,   4,  89,\
            # monkey
            58, 399, 276, 217, 444, 394, 463, 505, 325, 467, 373, 317, 385, 219, 342, 181, 297,  73,\
            485,  17, 378, 445, 209, 441, 259,   5,  15, 406, 490, 264,  99, 457, 327, 292, 168, 240,\
            # ship
            363, 469, 216, 510, 182, 401, 312, 391, 340, 426,  75, 422, 208, 440, 351,   7, 336, 477,\
            51, 308, 124, 472, 343, 380, 296, 341,  81, 474, 276,  97, 374, 509, 277, 291,  18,  93,\
            # truck
            427,  88,  93, 174, 296, 191, 134, 446,  53, 111, 383,  84,  22, 208, 330, 356, 165, 379,\
            20, 413, 417, 170, 157, 483, 284, 412, 440, 390,  50, 403, 471, 372, 261, 336, 406, 419
            ]'''
        
        '''
        # 加信道的卷积核权重排序 snr=20db
        index = [
            # airplane
            104,\
                #  182, 321, 211, 214,\
                #  431, 190, 422, 234, 315,\
                #  398, 193,  34, 426,  56,  81, 156, 295,\
            # 142, 148, 435, 417, 395, 131, 402, 283, 231,  31,  38, 400, 293, 384, 349, 102,  90, 486,\
            # bird
            245,\
                #  17, 257, 506,  82,\
                #   70, 316, 255, 237, 459,\
                #  102, 373, 411, 129,  78, 169, 305, 504,\
            # 219, 447, 253, 161, 358, 127, 321,  24, 177, 488, 441, 114, 118, 221, 351, 368,  49,  41,\
            # car
            269,\
                #  367, 427, 277,   1,\
                #  461, 138, 122, 205, 403,\
                #  128, 330,  30, 176,  32, 278, 476, 348,\
            # 27, 129, 376, 400, 377, 260,   8, 127,  92, 503, 207, 446, 404, 119,  62, 222, 389, 152,\
            # cat
            156,\
                #  47, 179, 255, 167,\
                #  309, 301, 310, 468, 185,\
                #  189,  12, 345, 187, 213, 505, 323,  51,\
            # 228,  65, 125, 369, 410, 285, 267, 265,  49, 408, 442, 460, 136, 320, 298, 358,  97, 101,\
            # deer
            263,\
                #   17, 346, 120, 316,\
                #  315, 413, 489, 463, 266,\
                #  318, 250, 202, 414, 438, 333, 410,  37,\
            # 252, 158, 211, 310, 259,  33, 444, 468, 494, 292, 147, 420, 475, 126, 161, 157, 385, 302,\
            # dog
            280,\
                #   83, 244, 153, 180,\
                #  100, 138, 457, 347, 281,\
                #  270, 331,  21, 185, 177, 333, 134, 124,\
            # 55, 301, 294, 372, 171, 274, 173, 249, 235, 209, 106, 309, 368, 445,  15, 441,  31, 429,\
            # horse
            5,\
                #   42, 371, 374, 375,\
                #   69, 148, 492,  43,  62,\
                #  274,  44, 472, 204, 304,   2, 308, 120,\
            # 338, 124, 212, 231, 437, 219, 459, 433, 111, 118, 238, 132,  79, 414, 462, 430, 400, 221,\
            # monkey
            297,\
                #  255, 378,  58, 471,\
                #  307, 257, 311, 159,  77,\
                #  399, 149, 443, 318, 453, 505,  53, 275,\
            # 385, 117, 179, 493, 114, 472, 325, 256, 356,  11, 165,  87, 242, 362, 238, 258, 370, 416,\
            # ship
            480,\
                #   56, 469, 421, 216,\
                #  510, 464, 426, 363, 435,\
                #  296,  85,  97, 182, 174, 477, 142,  23,\
            # 391, 241, 242, 128, 364, 233, 197, 485, 193, 112, 285,  26, 472, 274,  81, 424, 374, 448,\
            # truck
            427,\
                #   88, 383, 371,  75,\
                #  190, 175, 160, 446, 483,\
                #  403, 134, 143,  21, 354, 481, 174, 330,\
            # 390,  93, 287, 341,  77,  52, 233, 296, 509, 130, 419, 109, 469,  53, 121, 374, 456, 366
        ]
        '''

        '''
        # 加信道的卷积核权重排序 snr=10db
        index = [
            # airplane
            182,\
                #  431,  29, 193, 360,\
                #   51,  34, 321,  76, 104,\
                #  426, 109,  59, 339, 486, 435, 422, 203,\
            # 22,  54, 166, 190, 112, 479, 186, 314, 248, 197, 148,   7,  65, 265, 481,   3, 507, 395,\
            # bird
            245,\
            #  337,  82,  17, 102,\
                #  288, 498, 255, 447, 257,\
                #  161, 137, 488, 411, 504, 252,   3, 148,\
            # 231,   2, 241, 203, 240, 423, 457, 114, 280, 301, 404, 189,  60, 508, 305, 460,  73, 297,\
            # car
            32,\
                #  279, 116, 143, 377,\
                #  177, 176, 500, 427,  52,\
                #  184, 278, 386, 392, 494, 387, 327, 235,\
            # 403, 269, 128, 122, 330, 486, 348, 367, 287,  99,  96, 461, 163, 197, 503,  41, 439, 324,\
            # cat
            271,\
                #  298, 167,  21,  47,\
                #  410,  99, 189, 408, 107,\
                #  156, 280, 178, 153, 460, 396,  51, 146,\
            # 301, 501,  80, 259, 225,  26, 310, 449, 364, 309, 161, 179, 338, 317,  32, 291, 493, 313,\
            # deer
            64,\
                #  250, 411, 263, 145,\
                #   17, 316,  18, 450, 244,\
                #  398, 202,  53, 120, 357, 292, 344, 228,\
            # 206, 346,  89, 361, 259, 489, 117, 182, 264,  62, 420, 297, 108, 405, 318, 325, 446,  46,\
            # dog
            280,\
            #   83, 100, 393, 166,\
                #  289, 177, 364, 263, 300,\
                #  221, 501, 415, 274,   9, 484, 180, 271,\
            # 244, 377, 331, 193, 198, 358, 343, 437, 510, 228, 204, 282, 372,  20, 350, 209, 327, 380,\
            # horse
            374,\
                #  424,  98, 353, 504,\
                #  254, 475, 462, 120, 158,\
                #  124, 414,  92, 151, 236, 274, 132,  83,\
            # 53, 227,   5,   9, 316,  80,  69, 217,  86, 443, 355, 326,  40, 241,  62,  89, 125, 202,\
            # monkey
            471,\
                #  255, 485, 178, 307,\
                #  488, 385, 217, 412, 210,\
                #  454, 181, 276, 257,  17, 311,  99, 183,\
            # 159, 275, 425, 317, 378, 408, 149, 100, 393, 168,  87, 325,  62, 399, 152, 318, 258, 162,\
            # ship
            426,\
                #  480,  56, 435, 469,\
                #  510,   7, 216, 246,  85,\
                #  103, 133, 363, 116,  71, 423, 407, 119,\
            # 491,  54, 251, 502, 320,   2,  23, 147, 392, 215, 482, 192, 290, 306, 182, 428, 229, 507,\
            # truck
            427,\
                #  371, 143, 220, 235,\
                #  175, 390, 440,  30,  93,\
                #   13,  88,   4, 111, 277, 121, 327, 397,\
            # 303, 287, 262, 134, 368, 370, 169, 412, 261, 252, 409, 212,  52, 383, 417, 174, 192, 191
        ]
        '''

        '''
        # 冻结部分卷积层，考虑信道SNR=0dB
        index = [
            # airplane
            343,\
                #   51, 481, 106, 304,\
                #   81, 308, 376, 387, 241,\
                #  147, 390, 327, 184,  40, 475, 311, 104,\
            # 263, 202, 462,  11, 145, 126, 138, 345, 159, 277, 307, 473, 492,  68, 392, 397, 267, 486,\
            # bird
            182,\
                #   58, 164,  82, 317,\
                #  122, 454, 504, 293, 316,\
                #  237, 439, 203, 216,  54, 328,  30, 187,\
            # 257,  76, 137, 166, 201, 352, 426, 455, 390, 292, 503, 159, 264, 267,  33, 313, 326, 458,\
            # car
            489,\
                #  269, 292, 205, 480,\
                #  356, 181, 106, 288, 472,\
                #  113, 199, 365,  91, 427, 421, 114,  61,\
            # 415, 325,  22, 240, 194, 306, 484, 295, 282,   7, 302,  10, 420, 490, 355, 214, 115,  64,\
            # cat
            170,\
            #  491, 495, 467, 399,\
                #   41, 230, 107, 143, 198,\
                #   66, 166,  97,  46,  86,  78, 437,  82,\
            # 443,  33, 209, 258, 144, 413, 427, 165, 179, 453, 370,  57, 342, 250, 157, 313, 206, 393,\
            # deer
            34,\
                #  411,  92, 261, 221,\
                #   17, 406,  97, 280, 369,\
                #   78, 424, 217,  33, 460, 120, 284, 432,\
            # 249, 255, 396, 248, 509, 333,  19, 147, 142, 123,  79, 474, 444, 394, 312, 232, 297, 388,\
            # dog
            83,\
                #  206, 388,  25,  78,\
                #   66, 490,  69, 384, 358,\
                #  399, 187, 331, 118, 129, 315, 466, 132,\
            # 299, 150, 244, 222, 393, 192, 443, 168, 497, 413, 444, 105,  93,  74, 248, 294, 165, 148,\
            # horse
            363,\
                #  210, 172,  48, 221,\
                #  261, 150, 451,  43, 431,\
                #  305, 460, 300, 161, 400, 444, 204, 173,\
            # 272, 396,  21, 100, 435, 218, 315, 230, 263,  60, 465, 466,  19, 481, 132, 361, 424, 382,\
            # monkey
            256,\
                #  436, 275, 303, 413,\
                #  458, 209, 398, 371, 476,\
                #  200,  17, 379, 503, 400,  39, 165, 262,\
            # 482, 107, 258, 508, 410, 431, 491, 367,  20, 323,  56,  44, 182, 409, 218, 301, 435, 432,\
            # ship
            471,\
                #  259, 274, 426, 184,\
                #  319, 462, 382, 246, 336,\
                #  440,  28, 461, 402, 477, 101, 139, 391,\
            # 121,  36, 343, 307, 271, 219, 421, 348, 224, 285, 233, 480, 362, 337, 141, 266, 103, 338,\
            # truck
            383,\
                #  328, 340, 341,  31,\
                #  177, 389, 226, 110,  22,\
                #   88, 199, 339, 397, 183, 160,  29, 370,\
            # 73, 134, 265, 472, 171, 238, 484, 355, 109, 499, 229, 387, 121, 502, 319, 440, 374, 420
            ]
        '''

        '''
         # 冻结部分卷积层，考虑信道SNR=5dB
        index = [
            # airplane
            452,\
                #  360,   7, 398, 349,\
                #  304, 293, 321,  48, 418,\
                #  182, 264, 254, 152,  34, 347, 482, 431,\
            # 395, 104, 126, 403, 315, 139, 426,  95, 109, 243, 220, 272, 234, 176,  93, 339, 434, 214,\
            # bird
            161,\
                #  137, 506,  37, 252,\
                #  327, 135,  17, 169,  60,\
                #  488, 237, 247, 297, 203,  79, 404, 268,\
            # 321,  47,  70, 255, 399, 476, 373, 338, 200,  93, 324, 511,   1, 170, 248, 245, 231, 131,\
            # car
            269,\
                #  122, 176, 282, 367,\
                #   16, 123, 261, 127,  32,\
                #  429, 382, 327, 214, 473, 446, 330, 496,\
            # 278, 362, 140, 387,   6, 262,   3,  19, 205, 507, 195, 323, 135, 216, 277,  49, 292, 221,\
            # cat
            35,\
                #  493, 223, 444, 468,\
                #  331, 285, 255,  20, 485,\
                #   95, 156,   8, 369, 404, 157,  64, 251,\
            # 87,  81,  80, 228, 484, 175, 415, 410, 180, 351, 504, 408, 461, 189, 310, 298, 230, 309,\
            # deer
            202,\
                #  450, 416, 466, 207,\
                #  166, 244, 463, 439, 310,\
                #  162,  46, 411,  43, 483, 441, 240, 406,\
            # 296, 500, 211, 142,  44, 161, 208, 129, 414, 171,  30, 468, 316, 495, 499, 315, 455, 511,\
            # dog
            280,\
                #  368, 153, 244, 228,\
                #  331,  83, 110, 457, 218,\
                #  372, 285,  69, 204, 279, 420, 150, 256,\
            # 376, 326,  64, 501, 193, 445, 316,  47, 166,  78, 333, 313, 198,  71,  36, 124, 249, 215,\
            # horse
            374,\
                #  502, 331, 492, 375,\
                #  181,  71,  74, 120, 448,\
                #  478,   5, 400, 304, 464, 103,   2, 129,\
            # 203, 158,  43,  78, 151,  83, 458, 188, 187, 252, 110,  20,  85, 121, 309, 293,  29, 274,\
            # monkey
            485,\
                #  255, 444, 121, 443,\
                #  279, 124, 136, 416, 322,\
                #  399, 453, 482, 237, 441,  58,  62, 118,\
            # 356, 430, 445, 280, 490, 505, 442, 158, 213, 362,  84,  20, 454, 371, 168, 460,  40, 157,\
            # ship
            510,\
                #  452, 480, 469, 147,\
                #  208, 109, 440, 422, 391,\
                #  220, 246, 142,  95, 465, 363, 160, 421,\
            # 417, 467,  91, 103, 505, 435, 407,  11,   7, 335, 481, 184, 242, 426, 393, 105, 347, 174,\
            # truck
            334,\
                #   75,  88, 190, 143,\
                #   85, 272, 427, 459, 488,\
                #  403, 481, 429, 140, 363, 437, 405, 116,\
            # 117, 377, 508, 134, 166, 270, 282, 276, 338, 407, 262, 246, 216, 261, 486, 383,  90,  45
            ]
        '''

        '''
        # 冻结部分卷积层，考虑信道SNR=15dB
        index = [
            # airplane
            321,\
                #  193, 398, 360, 182,\
                #  104, 248, 483, 507, 341,\
                #  486, 395, 211, 272, 283,  56, 221, 290,\
            # 23, 186, 417, 109, 401, 508,  13, 426, 105, 163, 130,  32,  79,  34,  69,   8, 403, 375,\
            # bird
            245,\
                #  201,  17,  54, 434,\
                #  506, 203,  82, 161,  24,\
                #  488, 131, 511, 508, 215,  26,   5, 119,\
            # 102, 486, 316, 415,  39, 411, 188, 186, 221, 137, 107, 145, 490, 339,  70, 249, 252, 248,\
            # car
            427,\
                #  176,  32, 278, 122,\
                #    1, 503, 143, 184, 326,\
                #  446,  76,  96, 135, 494,  77, 261, 167,\
            # 329, 277, 367, 205, 377, 128, 387, 138, 356, 253, 269, 140, 382, 348, 116, 105, 473, 349,\
            # cat
            156,\
                #  301, 189, 280, 192,\
                #   46,  99,  51, 309, 468,\
                #  285, 496, 501, 449,  97, 408, 250, 443,\
            # 6, 461, 225, 159, 369, 181, 198, 323,  80, 404, 108, 255, 179, 298, 320, 271,  75, 314,\
            # deer
            346,\
                #  120, 202,  62, 316,\
                #  489, 444, 333, 263, 158,\
                #  361, 214, 250,  17, 292,  14, 266, 144,\
            # 411, 410, 455, 398, 420, 119, 350, 380, 272, 234, 357,  10, 280,  30, 215, 255, 500, 278,\
            # dog
            83,\
                #  100, 280,  36, 212,\
                #  418, 485, 282, 180, 354,\
                #  430, 260, 331, 405, 347, 153,  27, 266,\
            # 283, 289, 185,  98,  95,  25, 177, 138, 410, 222, 429, 134, 395, 256, 281, 173, 368, 274,\
            # horse
            375,\
                #  424, 374, 120, 202,\
                #    5, 414, 236, 309, 303,\
                #  133, 397, 114, 212,  42, 439, 254, 475,\
            # 312, 430,  18, 232, 148,  94, 491, 226, 228, 443, 451, 400, 292, 433, 129, 140, 187, 158,\
            # monkey
            311,\
                #  149, 307,  59, 297,\
                #  471, 255, 152, 181, 460,\
                #   17, 394,  65, 257, 179, 117, 453, 242,\
            # 217, 488, 162, 505, 118, 399, 378, 210, 165,  58, 463, 445, 356, 197, 485, 332, 352, 317,\
            # ship
            480,\
                #  510,  56, 363, 340,\
                #  391, 218,  10, 168, 469,\
                #  455, 407, 216, 174, 334,  67,  23, 296,\
            # 84, 274, 229, 421, 267, 206,  85, 164, 184, 412, 123, 426, 436, 256,  15,  97,  40, 440,\
            # truck
            88,\
                #  427, 398,  34, 121,\
                #  296,  75, 328, 291, 484,\
                #  160, 440, 371,  76,  30,  71, 116, 143,\
            # 409, 372, 363,  37, 446, 110, 109,  93, 341, 436, 193, 134, 261, 233, 140, 269,  80, 435
            ]
        '''

        '''
        # 冻结部分卷积层，修改resnet分类器结构，考虑信道SNR=0dB
        index = [
            # airplane
            321,   7, 510,  38, 104,\
            # bird
            17, 245,  54,  29, 504,\
            # car
            135, 425, 327, 176,  16,\
            # cat
            156, 317, 229, 167, 392,\
            # deer
            346,  43, 411, 158,  62,\
            # dog
            83,   9, 156, 228, 239,\
            # horse
            120, 202,  14, 129,  42,\
            # monkey
            255,  17, 213, 100, 291,\
            # ship
            510, 469, 182,  71, 223,\
            # truck
            117, 134, 121, 427, 371
            ]
        '''

        index = self.index

        x[:, index] = conv_output[:, index]
        x = self.model.avgpool(x)
        x = x.view(x.size(0), -1)  # Flatten

        # channel
        # snr = 25     #信噪比
        # snr = 10**(snr/10.0)  
        # xpower = torch.sum(x**2,1)/512.
        # npower = xpower/snr
        # noise = torch.FloatTensor(512,x.size(0)).to("cuda")
        # noise = noise.normal_()*torch.sqrt(npower)
        # noise = noise.transpose(1,0)
        # x = x + noise

        x = self.model.fc(x)
        return conv_output, x

class CamExtractor_vgg16():
    """
        Extracts cam features from the vgg16 classification model
    """
    def __init__(self, model, index, target_layer):
        self.model = model
        self.target_layer = target_layer
        self.gradients = None
        # N = range(512)
        # m = 50
        # self.index = random.sample(N, m)
        self.index = index

    def save_gradient(self, grad):
        self.gradients = grad

    def forward_pass_on_convolutions(self, x):
        """
            Does a forward pass on convolutions, hooks the function at given layer
        """
        conv_output = None
        for name, layer in self.model.features._modules.items():
            x = layer(x)  # Forward
            if int(name) == self.target_layer:
                conv_output = x  # Save the convolution output on that layer
                # return conv_output, x
        return conv_output, x

    def forward_pass(self, x):
        """
            Does a full forward pass on the model
        """
        # Forward pass on the convolutions
        conv_output, x = self.forward_pass_on_convolutions(x)
        conv_output_np = conv_output.data.cpu().numpy()
        x = torch.zeros(conv_output_np.shape).to("cuda")
        
        '''
        # 不加信道、冻结所有卷积层的模型卷积核权重排序
        index = [
            # airplane
            143,   6, 283, 419, 135, 176, 345, 420, 103, 155, 131, 154, 405, 187, 310, 145, 425, 106,\
            229,  82,  71, 181, 232, 318, 454, 161,  98, 416, 502, 481, 207, 319, 112,  76, 243, 231,\
            # bird
            260, 102, 331, 140, 419,  50, 474,   7, 104, 178, 139, 190, 201, 106, 141, 133, 319,  23,\
            417, 350, 189,  18, 349, 217, 243, 501, 392, 250,   2, 222, 283,  90,   0, 125,  99, 327,\
            # car
            62, 333, 411, 343, 465, 135, 233, 324,  88, 384, 405, 283, 430,  37, 495, 318, 154, 103,\
            107, 251, 143, 119, 316, 149, 488, 418, 371, 477, 145, 155, 350, 279, 424, 412,  17, 408,\
            # cat
            328,  97, 210, 122,  90, 171,  18, 286, 128, 471, 160, 436, 346, 133, 268, 385, 247,   0,\
            132, 413, 444,  79, 322,  45, 266, 279,   7,   1, 296, 186, 398,  75, 189,  62, 417, 191,\
            # deer
            182, 232, 190, 243, 167, 227, 332, 247, 501, 210, 149, 219,   2, 309, 435, 150, 188,  86,\
            274, 433, 444, 110, 191,  28, 447, 141, 160, 240, 422, 250, 342, 417,  76, 463, 215, 267,\
            # dog
            436, 375, 446, 274, 198, 383, 122, 129, 151, 275, 279, 218, 272, 121,   3, 428, 460, 339,\
            367, 120,  97,  30, 322, 212, 223, 296, 473, 407, 160, 506, 216, 286,  39, 479, 164, 257,\
            # horse
            127, 433, 182, 501,   3, 420, 149,  15, 224,  43, 177, 230,  71, 339, 358,   4, 332, 123,\
            382,  10, 216,  29, 303, 401, 436, 373,  92, 167, 232, 421, 435, 284, 273, 438, 198, 204,\
            # monkey
            474, 487, 247, 410, 442,  50, 438, 506, 102,  32, 314,  99,  94,  66, 104, 244, 349, 217,\
            450, 272, 278,  23, 250, 266, 158, 259, 241, 216, 269, 178, 170, 299, 268,  16, 346, 507,\
            # ship
            345, 187, 378, 476, 105,  90, 180, 395, 289, 131, 419,  67, 161, 453, 149,  63, 285, 132,\
            148, 166, 448, 235, 348,  33, 240, 211, 357, 263, 315,  38, 429,  71, 221, 107, 202,  31,\
            # truck
            127, 202, 271, 378, 363,  40, 119,  62, 254, 289, 411, 453, 233, 135, 103, 156,  12, 504,\
            149, 181, 312, 433, 384, 105,  43, 107, 372, 123,  42, 177, 472, 280, 132,  25,  63,  17
            ]
        '''
        
        '''
        # 不加信道、冻结部分卷积层的模型卷积核权重排序
        index = [
            # airplane
            176,\
                #    6, 187, 143, 318, 112, 229, 103, 289, 345, 105, 419, 135, 154, 405, 310, 338, 416,\
            # 145, 155, 420, 319,  71,  76, 366,  38,  83, 407,  49,  82, 283,  93, 127, 207, 211, 454,\
            # bird
            331,\
                #  260, 102, 141, 184,   50, 311, 190, 139, 178, 140, 115, 353, 501, 106, 417, 104,   2,\
            # 222, 243, 387, 319, 266, 474, 232, 360, 366,   9, 422,  90, 300, 163, 201, 207,   7, 250,\
            # car
            62,\
                #  333, 411,  88, 343,  405, 384, 107, 233, 318, 283,   6, 393, 324, 477, 154, 229,  67,\
            # 93, 445,  25, 155, 143, 495, 145,  17, 488, 371, 206, 430, 319, 408, 424, 127, 316, 135,\
            # cat
            328,\
                #  247, 210,  62,  97,   90, 128, 132, 160, 279, 346, 122, 219, 417, 398, 322, 471, 171,\
            # 117,  16,  79, 174, 375,  18,   7, 267, 296, 121, 392, 385, 251, 436, 413, 356, 404, 495,\
            # deer
            232,\
                #  243, 182, 240,  86,  227, 190, 501, 332, 422,  188, 247, 141, 358, 433, 191, 160,   2,\
            # 447, 210, 394, 219, 267, 435, 117, 417, 140, 455, 167, 313,   3,  46, 320,   0, 309,  50,\
            # dog
            274,\
                #  151, 198, 322, 223,    3, 446, 275, 436, 129, 375, 212, 121,  25, 120, 420, 218,  26,\
            # 383, 296, 428, 506, 288,  39, 339, 460, 279, 473, 272, 284,  51, 122, 340,  30, 490, 507,\
            # horse
            3,\
                #  127, 182, 501, 420,  223,  43, 303, 274, 243,  230, 433,  29, 216,  10, 123,  92, 438,\
            # 284,  71, 332, 151, 227, 436,  86,  44, 358, 426,  51,  15, 257, 394, 352, 218, 401, 370,\
            # monkey
            474,\
                #  438, 102,  50, 487,  247, 506, 442, 410, 278, 509, 117, 323, 269, 417, 259,  99,  32,\
            # 421,  66, 178, 446, 387, 141, 140, 210, 244, 299, 216, 223, 116, 358, 267, 160, 104, 379,\
            # ship
            345,\
                #  378, 476, 289, 187,  105, 180,  90, 419, 448,  107, 453, 161, 131, 398, 270,  38,  67,\
            # 357,  22, 166, 148, 508, 224, 202,  33, 403,  71, 265, 316, 285, 235,  48, 372, 395, 483,\
            # truck
            127,\
                #  202, 271 , 62, 289,  411, 378, 254,  40,  25,  107, 453, 233,  43, 119, 363, 372, 477
            # 32, 384, 155, 336, 397, 265, 292, 105, 156,  92, 416,  38,  67,  71, 214, 135, 293, 357
            ]
        '''

        '''
        # 冻结部分卷积层，考虑信道SNR=10dB
        index = [
            # airplane
            176,\
            #  187, 318, 345, 112,   6, 419, 143, 135, 103, 289, 405, 319,  82, 105, 366, 145, 207,\
            # 416, 106, 229, 481, 310, 420, 231, 407, 338,  51, 155, 154, 365,  71, 491,   5,  38, 465,\
            # bird
            331,\
            #  260, 102,  50, 141, 184, 106, 190, 140, 139, 417, 311, 501, 178, 353,   7,  90,   0,\
            # 189, 387, 232, 474, 243,   2, 419,  18, 266, 104, 201, 125, 319, 163, 115, 171, 286, 207,\
            # car
            411,\
            #   88, 333,  62, 343, 318, 405, 107, 233, 384, 127, 477, 283 ,393, 206, 154,  67,   6,\
            # 143, 145, 495, 388,  32, 316, 371, 324, 135, 408,  41,  93, 119, 465, 229,  37,  25, 155,\
            # cat
            328,\
            #   90, 247, 132, 210,  97, 128,  62, 122, 322,  18, 219, 346, 160, 417, 471, 413, 174,\
            # 79, 361, 385, 353, 507, 299, 279,   7, 398, 121, 367, 458, 117, 171, 375, 267, 251, 387,\
            # deer
            232,\
            #  190, 182, 243, 422, 240, 332, 227,  86, 417, 394, 501, 219, 247, 141, 358, 140,   2,\
            # 274, 466, 433, 455, 188, 191,  46, 250, 215, 210,  65, 447,  43,  50, 313, 177, 160,  28,\
            # dog
            274,\
            #  198, 446, 322, 151, 275, 223, 129,   3, 212, 436, 506, 120, 383,  25, 375,  26, 509,\
            # 296, 218, 121, 272,  39, 428, 257, 284, 339, 367, 259, 288, 122,  36,  92, 460, 123, 179,\
            # horse
            3,\
            #  127,  43, 182, 501, 230, 420,  29, 243, 274, 223, 227, 123, 433,  15,  92, 284,  10,\
            # 438,  86, 303, 332, 358, 257, 436,  71, 394,  51, 177, 308, 216, 382, 151, 446, 359, 339,\
            # monkey
            474,\
            #  438,  50, 247, 506, 442, 102, 410, 487, 509, 417, 507, 178, 259,  32, 140,  66, 349,\
            # 269, 299, 223, 278, 446, 314, 125,  99, 322, 323, 387, 267, 117,   0, 116, 216, 141, 158,\
            # ship
            289,\
            #  378, 345, 476, 187, 105, 419,  90, 180, 448, 161, 395,  33, 270, 131, 265, 132,  22,\
            # 263, 235,  38, 107, 206, 135,  67, 398, 202, 291, 409, 316, 224, 453, 112, 444, 148, 330,\
            # truck
            127,
            #  202, 289, 378, 271,  43, 411, 233,  40,  62,  25, 107, 254,  32, 119, 363, 477, 453,\
            # 156, 372, 181, 433, 177, 265, 135, 283, 214,  67, 292, 123, 155,  12, 384, 206,  38, 416
            ]
        '''

        '''
        # 冻结部分卷积层，考虑信道SNR=0dB
        index = [
            # airplane
            419,  135, 143, 318, 103,\
            #      176,   6, 106,  71, 187, 289, 112,  82, 319, 366, 145, 405, 105,\
            # 476, 439, 465,  38, 372, 207, 345, 444,  48, 225, 253,  46, 310, 491, 338, 231, 131, 365,\
            # bird
            260,   50, 106, 178, 102,\
            #      141, 474,  23, 247, 253, 501, 331, 140, 419,  82, 143, 103, 439,\
            # 187, 207, 444, 350, 319, 417, 184, 189, 176, 104, 365, 133, 311, 509, 139, 173, 366,   7,\
            # car
            233,  411,  62, 283, 477,\
            #      318, 343, 405,  88, 107, 384, 135, 143, 316, 418, 333, 488, 251,\
            # 67,  93,   6, 495, 430, 424, 154, 131, 372,  25, 127, 271, 363, 133, 145, 408,  37, 119,\
            # cat
            247,  296, 210, 117, 141,\
            #      328, 507, 436, 471, 122, 160, 479, 322, 446, 373,  23, 168, 286,\
            # 90,  69, 356,   7,  18,   2, 279, 189, 375, 299, 425, 179, 428,  62, 351, 440,   0, 362,\
            # deer
            240,  182, 232, 247,  86,\
            #      358, 501, 243, 160, 151, 141,   2,   3, 274, 210, 219, 117, 223,\
            # 227, 337, 466, 356, 370, 332, 167, 394,  52,  10, 359,  69, 352, 140, 125, 479, 362,  13,\
            # dog
            296,  223, 446,   3, 507,\
            #      247, 151, 322, 436, 274, 438, 509, 117, 210, 198, 275, 206, 284,\
            # 122, 216, 375, 123, 441, 428, 487, 141, 339, 479,  44, 473, 272, 299,  15, 182, 425, 506,\
            # horse
            3,  182, 223, 274, 127,\
            #      151, 243, 501, 284,  43, 358, 433, 337, 352, 216,  86, 370, 438,\
            # 308, 123,  92, 227, 240,  15, 192, 303,  10,  71, 420, 339,  68, 359,  29, 446, 232, 265,\
            # monkey
            247,  296, 141,  50, 507,\
            #      117, 509, 474, 210, 446,  23, 322, 438, 260, 436, 487, 102, 160,\
            # 442, 273, 373, 178, 410, 244,  44, 140,  69, 269, 198, 299, 104, 168,   2, 122,   7, 206,\
            # ship
            419,  289, 453, 476, 378,\
            #      187, 166, 135, 345, 180,  71, 409,  90, 148,  38, 363, 131, 103,\
            # 215,  48, 348, 105, 336,  67, 508, 366, 444, 448, 429, 112, 372, 397,  22, 225, 181, 132,\
            # truck
            233,  127, 453, 271, 289,
            #  363, 378,  62, 283, 202, 107, 135, 419, 411,  43, 336, 477,  67,\
            # 254,  25, 166, 372,  32, 148, 192, 181,  72, 476, 214,  38, 397, 280, 348, 316, 156, 430
            ]
        '''

        '''
        # 冻结部分卷积层，考虑信道SNR=5dB
        index = [
            # airplane
            112,   6, 187, 176, 135, 318, 345, 143, 419, 103,  82, 145, 405, 366,  71, 319, 105, 310,\
            38, 481, 289, 231, 106, 454, 229, 338, 407, 416,   5,  83, 154,  76,  46, 491, 365,  93,\
            # bird
            331, 260, 102, 141, 140, 178,  50, 311, 417, 139, 190, 353, 106, 184, 365, 501, 104, 474,\
            243, 187,  90, 232,  18,  46, 387,   7, 419, 422, 115, 173, 350, 349, 444, 189, 253,  23,\
            # car
            62, 233, 107, 411, 333,  88, 343, 405, 384,   6, 477, 393, 318,  25,  32, 283, 135, 324,\
            67,  93, 251, 154, 371, 488, 143, 430, 229,  94,  17, 445, 127,  41, 129, 424, 388, 408,\
            # cat
            328, 247, 210,  90,  62, 322,  97, 122, 132, 296, 219, 471, 128, 436, 353, 174, 160, 117,\
            299, 279, 507, 375, 121, 417, 286, 503,   7,  18, 346, 356, 385, 361, 367, 251, 171, 227,\
            # deer
            182, 232, 240, 243, 219, 227,  86, 332, 422, 501, 394, 274, 223,   3, 358, 247,  50, 188,\
            210, 43, 167, 191, 141, 267,   2, 151, 117, 190, 177, 328, 284, 420, 320, 160, 435, 309,\
            # dog
            274, 223, 151, 275,   3, 198, 129, 446, 322, 212, 375, 436, 420, 121, 284, 296, 507, 272,\
            25, 460, 383, 328, 122, 339,  51, 367, 218, 428, 120, 288, 174, 506, 509, 257,  92, 320,\
            # horse
            3, 223,  43, 274, 127, 182, 420, 243, 303, 284, 501, 433, 227,  92, 151, 123,  29, 257,\
            71, 438, 352, 216, 358, 370, 332,  49, 278, 454, 230, 308, 339, 359,  86,  51, 232,  15,\
            # monkey
            474, 438,  50, 247, 509, 442, 487, 446, 410, 507, 102, 141, 506, 278, 322, 178, 244, 117,\
            44, 259,  32, 104, 417,  99, 299, 140, 223, 428, 273, 116, 168,  16, 216, 296, 421, 272,\
            # ship
            345, 378, 289, 476, 419, 187, 180, 448, 105,  90, 135, 453, 107,  67, 148,  38, 265, 131,\
            33, 398, 270, 491, 166, 395, 409, 291, 363, 112, 161,  71, 336, 316, 263, 348, 132,  22,\
            # truck
            127, 271, 233, 107, 378, 289,  62, 202, 363, 453,  43, 411, 477,  25,  32,  40, 254, 283,\
            135, 265,  67, 214, 119, 384, 156, 181, 336, 372, 148,  12, 416, 316, 409, 433,  38,  71
            ]
        '''

        '''
        # 冻结部分卷积层，考虑信道SNR=15dB
        index = [
            # airplane
            176,\
            #  187,   6, 143, 419, 103, 345,  82, 135, 366, 112, 420, 416, 105, 318, 289, 310, 229,\
            # 481,  83, 405,  51, 338, 407,   5,  71, 231, 207, 319, 154,  76, 181,  98,  23, 145,  38,\
            # bird
            331,\
            #  260, 102, 141, 140,  50, 184, 115, 139, 190, 104, 311, 243, 419, 106, 417, 474, 189,\
            # 387, 501, 163, 353, 178,  23, 250,   7,   2,  46, 266, 206, 187, 133, 176, 222, 232,  99,\
            # car
            62,\
            #  333,  88, 405, 411, 343, 318, 233, 384, 393, 107, 324, 283, 154,   6, 135, 316, 495,\
            # 119, 229,  37,  93,  17, 143, 206,  25, 430, 477,  94, 155, 145, 371,  42, 488, 251, 424,\
            # cat
            328,\
            #   90, 210, 247,  97, 219, 122, 132, 346, 471, 160, 322, 268, 398, 417, 128, 279, 413,\
            # 171, 385,  18, 361, 117, 174, 375,   7, 296, 110, 476, 446, 463, 232,  31,   2, 267, 266,\
            # deer
            232,\
            #  243, 182, 422, 190, 240, 227, 501, 394, 141,  86, 332, 417, 191, 188, 210, 247, 274,\
            # 167, 309, 219, 466, 433, 435, 358, 250,   2,   0, 455,  65, 160,  50, 313, 300,  28, 140,\
            # dog
            274,\
            #  151, 198, 129, 275,   3, 223, 446, 322, 436, 212, 375, 383,  25,  39,  26, 121, 218,\
            # 120, 122, 272, 339, 506, 460, 279,  30, 509, 507, 428, 288, 164, 420, 257, 463, 299, 284,\
            # horse
            501,\
            # 127,\
            #  501,   3, 230, 420,  43,  29, 182, 438, 123, 433,  92, 223, 332,  71, 284, 303, 243,\
            # 206, 216, 436, 274,  15,  10, 257, 358, 426, 401, 394, 227, 454, 421,  51,  86, 308, 382,\
            # monkey
            474,\
            #  438,  50, 102, 247, 506, 442, 487, 410, 278, 117, 140, 259,  32, 417, 269, 171, 223,\
            # 216, 267, 509,   2,  99, 217, 160, 507, 158, 178,  16, 314, 323, 210, 379, 303, 349, 219,\
            # ship
            345,\
            #  378, 289, 187, 476, 419,  90, 105, 395, 448, 161, 180, 107, 131, 270,  38,  33, 453,\
            # 240,  22, 398, 224,  67, 148, 483, 135, 403, 291, 112, 263, 152, 357, 182, 414, 103, 211,\
            # truck
            127,\
            #  271, 202,  40, 378, 289, 233, 254,  62, 411,  43, 119, 283,  25, 477, 107, 363, 135,\
            # 103,  71,  38, 453, 384, 181, 292,  32, 372, 155, 433, 416, 105, 345, 491,  83,  67, 206
            ]
        '''

        '''
        # 冻结部分卷积层，考虑信道SNR=20dB
        index = [
            # airplane
            176,\
            # , 187,   6, 318, 143, 345, 420, 419, 112, 103, 135, 310, 105, 481, 289, 405, 416, 319,\
            # 229, 366,  82, 338, 207,  51,  71, 231,  38,  93,  49, 154, 106,  83,  76, 145, 407, 206,\
            # bird
            331,\
            # ,  260, 102, 141, 140,  50, 190, 115, 417, 501, 104, 184, 474, 163, 178, 139, 106, 266,\
            #   7, 232, 353, 349, 206,  18, 311,  99, 300, 387, 392, 133, 321, 222, 243,   2,  46, 189,\
            # car
            62,\
            # , 333,  88, 343, 411, 405, 318, 384, 107, 233, 154, 477, 324, 143, 229, 245, 393, 283,\
            # 93, 371,   6, 206, 135, 119,  37, 155, 430, 251,  17, 465, 495, 316,  94,  25, 185, 377,\
            # cat
            328,\
            #   97, 210, 219,  90, 247, 132, 122, 471, 171, 322, 117, 128, 417, 160, 346, 385, 279,\
            #  18, 436,   7,  62, 268, 375,  16, 267, 507,  79, 367, 463, 110, 398, 460, 141, 446,   2,\
            # deer
            232,\
            #  182, 243, 190, 422, 227, 332, 240,  86, 501, 394, 219, 210, 417, 247, 188, 358, 435,\
            # 141, 191, 140, 313, 167, 447,   2, 117,  43,  46, 274, 250,   0, 171, 300,  42, 150,  65,\
            # dog
            274,\
            # , 198, 151, 275, 223,   3, 322, 375, 129, 212, 446, 436,  26, 428, 383, 121, 122, 506,\
            # 460, 120, 218, 507,  25,  30, 299, 367, 284, 509, 288, 279, 473, 257, 117, 296, 339, 164,\
            # horse
            420,\
            # 127,\
            # , 420,   3, 230, 182,  29, 501,  43, 303, 438, 433, 123,  10, 257, 284, 223,  71, 454,\
            # 426, 206, 243, 274, 332,  92, 227, 177, 370, 216, 446,  15,  86, 308, 188, 382, 167, 143,\
            # monkey
            474,\
            # , 438,  50, 247, 102, 506, 410, 278, 442,  99, 487, 117, 417, 269, 223, 259,  32, 210,\
            # 267, 158, 140, 219, 509, 141, 454, 303, 507, 104, 299, 323, 171, 358, 66, 273, 217, 379,\
            # ship
            345,\
            # , 378, 187, 105, 476,  90, 289, 395, 419, 180, 448,  33,  22, 161, 107, 131,  38, 270,\
            # 148, 224,  67, 291, 483, 315, 348, 403, 171, 398, 490, 235, 414, 206,  31, 330, 453, 377,\
            # truck
            127,\
            # , 202,  62, 411,  40, 271, 233, 378,  25, 254, 107, 477, 119, 384,  43, 363, 292, 453,\
            # 181,  38, 289, 372, 103, 135, 177,  32, 283,  83, 416,  67,  10, 148, 155, 265, 433, 206
            ]
        '''

        # 随机抽样传输的卷积核
        index = self.index

        x[:, index] = conv_output[:, index]
        # x = self.model.avgpool(x)
        x = x.view(x.size(0), -1)  # Flatten

        # channel
        # snr = 15    #信噪比
        # snr = 10**(snr/10.0)  
        # xpower = torch.sum(x**2,1)/25088.    #25088
        # npower = xpower/snr
        # noise = torch.FloatTensor(25088,x.size(0)).to("cuda")
        # noise = noise.normal_()*torch.sqrt(npower)
        # noise = noise.transpose(1,0)
        # x = x + noise

        x = self.model.classifier(x)
        return conv_output, x

if __name__ == '__main__':
    chkpt_path = 'E:/机器学习/pytorch-cnn-visualizations-master/src/model_stl3.pth'
    img_path = 'E:/机器学习/pytorch-cnn-visualizations-master/input_images/train/3.png'

    model = Classification()
    model.load_state_dict(torch.load(chkpt_path, map_location='cpu'))
    model.eval()
    # summary(model, (3, 128, 128))
    print(model)

    image = Image.open(img_path)
    original_image = image.convert('RGB')
    original_image = original_image.resize((128, 128), Image.ANTIALIAS)
    image_np = np.array(original_image).astype('uint8')
    prep_img = preprocess_image(image_np)
    # target_class =  2# 

    y = model(prep_img)
    # print("original label: ", y.data)
    print("original label: ", y.data.numpy().argsort()[0][-1])

    layer_name = 'e_conv_3'

    cam_extractor = CamExtractor(model, target_layer=layer_name)
    conv_output, model_output = cam_extractor.forward_pass(prep_img)
    print("conv_output shape:", conv_output.shape)
    print("cropped label: ", model_output.data.numpy().argsort()[0][-1])
    print("classification completed")
